<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Homework 3 - MyWorld Data</title>

    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>

    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>


    <!--------------------------------->
    <!-- FROM HERE ON IT IS HW3 stuff-->
    <!--------------------------------->

    <!-- add own vis classes-->

    <script src = "js/plate_selector.js"></script>
    <script src = "js/dist.js"></script>
    <script src = "js/plate.js"></script>
    <script src = "js/scatter.js"></script>
    <script src = "js/cloud.js"></script>

    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

</head>
<body>
    <div class="container">
        <h1>Mightyscreen</h1>

        <div class="row">
            <div class="col-md-12 col-sm-12" id="plateSelector">
            </div>

        </div>


        <div class="row">
            <div class="col-md-9" id="distVis1">
            </div>
        </div>

        <div class="row">
            <div class="col-md-9" id="distVis2">
            </div>
        </div>

        <div class="row">
            <div class="col-md-9" id="distVis3">
            </div>
        </div>

        <div class="row">
            <div class="col-md-9" id="plateVis">
            </div>
        </div>

        <div class="row">
            <div class="col-md-9" id="scatterVis">
            </div>
        </div>


        <div class="row">
            <div class="col-md-12" id="cloudVis">
            </div>
        </div>



    <br>
    <br>
    <br>
    <br>
    <br>


    </div>



    <script>
        $(function(){ // this function is called after the HTML document is fully loaded


            //==========================================
            //--- HERE IS WHERE ALL THE MAGIC STARTS --
            //==========================================


            // variables keeping global knowledge of the data
            var allData = [];
            var groupedData = []; //grouped data is all data aggregated on plate number

            //channel are readouts selected for visualization  
            var channel_1  = "fpA";
            var channel_2  = "fiA";
            var channel_3  = "fpB";

            // this function can convert Date objects to a string
            // it can also convert strings to Date objects
            // see: https://github.com/mbostock/d3/wiki/Time-Formatting
            var dateFormatter = d3.time.format("%Y-%m-%d");


            // call this function after Data is loaded, reformatted and bound to the variables
            var initVis = function(){

                //TODO: Create an eventHandler  --> DONE :)
                var MyEventHandler = new Object();


                //TODO: Instantiate all Vis Objects here
                
                //TODO: channel selector
                //select which plate to display
                var plateselector = new PlateSelector(d3.select("#plateSelector"),groupedData,MyEventHandler);

                //channel 1 for selection
                var distvis1 = new DistVis(d3.select("#distVis1"),groupedData[0].values,channel_1,MyEventHandler);
                
                //channel 2 for selection
                var distvis2 = new DistVis(d3.select("#distVis2"),groupedData[0].values,channel_2,MyEventHandler);
                
                //channel 3 for selection
                var distvis3 = new DistVis(d3.select("#distVis3"),groupedData[0].values,channel_3,MyEventHandler);
                
                //plate heat plot
                var platevis = new PlateVis(d3.select("#plateVis"),groupedData[0].values,channel_1,MyEventHandler)

                //scatter plot
                var scattervis = new ScatterVis(d3.select("#scatterVis"),groupedData[0].values,channel_1,channel_2,MyEventHandler);

                //chemical cloud
                var cloudvis = new CloudVis(d3.select("#cloudVis"),groupedData[0].values,channel_1,1,MyEventHandler);

                // TODO: bind the eventHandler to the Vis Objects
                // events will be created from the CountVis object (nothing to do here)
                // events will be consumed by the PrioVis and AgeVis object (binding should happen here)
                //$(MyEventHandler).bind("selectionChanged", function(event, s, e){

                //     agevis.onSelectionChange(s,e);
                //     priovis.onSelectionChange(s,e);
                //     $("#brushInfo").text("From"+s+"To"+e);
                // });

            }

            // call this function after both files are loaded -- error should be "null" if no error
            var dataLoaded = function (error, _allData) {

                if (!error) {

                    allData = _allData.map(function (d) {
                        

                        var res = {
                            platewell: d.platewell,
                            plate:d.plate,
                            well:d.well,
                            welltype:d.welltype,
                            chemical_name: d.chemical_name,
                            fpA: parseFloat(d.fpA),
                            fpB: parseFloat(d.fpB),
                            fiA: parseFloat(d.fiA),
                            fiB: parseFloat(d.fiB),
                            inchikey: d.inchikey,
                            logp: parseFloat(d.logp),
                            mw: parseFloat(d.molecular_weight),
                        };

                        // clean up svg make it symbol and set the id to be 'sym'+platewell suppose to be unique
                        res.svg = d.svg ? "<symbol id='sym" + d.platewell + "'" + d.svg.split("<svg")[2].split("</svg>")[0]+"</symbol>" : "";

                        return res;
                    });
                    
                    //aggregate data based on plate number
                    groupedData = d3.nest()
                    .key(function(d) {return d.plate;})
                    .rollup(function(d) {return d;})
                    .entries(allData);

                    initVis();
                }
            }

            var startHere = function(){

                //TODO: load data here and call "dataLoaded" afterwards
                // Hint: http://giscollective.org/d3-queue-js/
                queue()
                .defer(d3.csv,"/data/demo_data.csv")
                .await(dataLoaded);


            }

            startHere();
        })
    </script>
</body>
</html>
